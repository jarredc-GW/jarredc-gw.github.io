<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Co-Ed Softball Scorecard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .roster-card {
            cursor: grab;
            transition: background-color 0.2s;
        }
        .roster-card:active {
            cursor: grabbing;
        }
        .roster-card.dragging {
            opacity: 0.5;
            background: #dbeafe;
        }
        .drag-over {
            border: 2px dashed #3b82f6;
            background-color: #eff6ff;
        }
        .invalid-order {
            border: 2px dashed #ef4444 !important;
        }
        .baseball-diamond {
            width: 85%;
            margin: 0 auto;
            aspect-ratio: 1 / 1;
            position: relative;
        }
        /* Mobile specific sizing (<700px) */
        @media (max-width: 700px) {
            .baseball-diamond {
                width: 60vmax;
                max-width: 100%; /* Prevent horizontal overflow */
            }
        }
        .baseball-diamond svg {
            width: 100%;
            height: 100%;
        }
        .base {
            position: absolute;
            width: 12.75%;
            height: 12.75%;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .base:active {
            transform: scale(0.9);
        }
        .base-label {
            position: absolute;
            font-size: clamp(0.6rem, 2vw, 0.75rem);
            font-weight: 500;
            color: #4b5563;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }
        .base.active .base-icon {
            fill: #3b82f6;
        }
        .base-runner-name {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(0.6rem, 2vw, 0.75rem);
            font-weight: 700;
            color: white;
            padding: 2px 5px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120%;
            display: none;
            z-index: 10;
        }
        .base.active .base-runner-name {
            display: block;
        }

        /* --- FINAL BASE POSITIONS --- */
        #home-plate { bottom: 5%; left: 42.5%; }
        #home-plate .base-label { bottom: -25px; }
        #first-base { bottom: 42.5%; right: 6.75%; }
        #first-base .base-label { bottom: -20px; left: 50%; transform: translateX(-50%); }
        #second-base { top: 7.5%; left: 42.5%; } 
        #second-base .base-label { bottom: -20px; left: 50%; transform: translateX(-50%); }
        #third-base { bottom: 42.5%; left: 6.75%; }
        #third-base .base-label { bottom: -20px; left: 50%; transform: translateX(-50%); }

        .prevent-select {
            -webkit-user-select: none;
            user-select: none;
        }

        #roster-toggle-content, #game-log-toggle-content {
            transition: all 0.3s ease-in-out;
            overflow: hidden;
        }
        
        /* Batting Indicator Classes */
        .batting-current {
            border-left: 4px solid #10b981; /* Green */
            background-color: #f0fdf4; /* Light green */
        }
        .batting-on-deck {
            border-left: 4px solid #f59e0b; /* Yellow */
            background-color: #fffbeb; /* Light yellow */
        }
        .batting-in-hole {
            border-left: 4px solid #fcd34d; /* Pale Yellow */
        }
        
        /* Drag Handle Style */
        .resize-handle {
            touch-action: none; /* Prevents scrolling while dragging on mobile */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
        
        <!-- Game Mode Selection -->
        <div id="game-mode-modal" class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full">
            <h2 class="text-xl font-bold text-center mb-6">Select Game Mode</h2>
            <div class="space-y-4">
                <button id="mode-traditional" class="w-full text-lg font-medium py-4 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Traditional Lineup
                </button>
                <button id="mode-wheel" class="w-full text-lg font-medium py-4 px-6 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    Bat the Wheel
                </button>
            </div>
            <p class="text-sm text-gray-500 mt-4 text-center">"Traditional" requires M/F alternate order.<br>"Bat the Wheel" uses separate M/F lists.</p>
        </div>

        <!-- "Who Bats First?" Modal -->
        <div id="who-bats-first-modal" class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full hidden">
            <h2 class="text-xl font-bold text-center mb-6">Who Bats First?</h2>
            <div class="space-y-4">
                <button id="start-male" class="w-full text-lg font-medium py-4 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Male
                </button>
                <button id="start-female" class="w-full text-lg font-medium py-4 px-6 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition-colors">
                    Female
                </button>
            </div>
        </div>

        <!-- "Select Your Team" Modal -->
        <div id="user-team-modal" class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full hidden">
            <h2 class="text-xl font-bold text-center mb-6">Which team are you?</h2>
            <div class="space-y-4">
                <button id="team-home" class="w-full text-lg font-medium py-4 px-6 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors">
                    Home Team
                </button>
                <button id="team-away" class="w-full text-lg font-medium py-4 px-6 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                    Away Team
                </button>
            </div>
        </div>

        <!-- "Hit Type" Modal -->
        <div id="hit-type-modal" class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full hidden">
            <h2 class="text-xl font-bold text-center mb-6">Select Hit Type</h2>
            <div class="grid grid-cols-2 gap-4">
                <button data-hit-type="1" class="hit-type-btn w-full text-lg font-medium py-4 px-6 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    Single (1B)
                </button>
                <button data-hit-type="2" class="hit-type-btn w-full text-lg font-medium py-4 px-6 bg-green-700 text-white rounded-lg hover:bg-green-800 transition-colors">
                    Double (2B)
                </button>
                <button data-hit-type="3" class="hit-type-btn w-full text-lg font-medium py-4 px-6 bg-green-800 text-white rounded-lg hover:bg-green-900 transition-colors">
                    Triple (3B)
                </button>
                <button data-hit-type="4" class="hit-type-btn w-full text-lg font-medium py-4 px-6 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
                    Home Run (HR)
                </button>
            </div>
             <button id="cancel-hit" class="w-full mt-4 py-2 px-4 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                Cancel
            </button>
        </div>
        
        <!-- Base Context Modals -->
        <div id="base-context-modal-1" class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full hidden">
            <h2 class="text-xl font-bold text-center mb-6">Runner on 1st</h2>
            <p class="text-center text-gray-700 mb-6">What happened to this runner?</p>
            <div class="space-y-4">
                <button data-action="move" data-base="2" class="base-action-btn w-full text-lg font-medium py-4 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Send to 2nd</button>
                <button data-action="move" data-base="3" class="base-action-btn w-full text-lg font-medium py-4 px-6 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors">Send to 3rd</button>
                <button data-action="score" class="base-action-btn w-full text-lg font-medium py-4 px-6 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">Runner Scored</button>
                <button data-action="out" class="base-action-btn w-full text-lg font-medium py-4 px-6 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Runner Out</button>
                <button data-action="cancel" class="base-action-btn w-full mt-4 py-2 px-4 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
            </div>
        </div>
        
        <div id="base-context-modal-2" class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full hidden">
            <h2 class="text-xl font-bold text-center mb-6">Runner on 2nd</h2>
            <p class="text-center text-gray-700 mb-6">What happened to this runner?</p>
            <div class="space-y-4">
                <button data-action="move" data-base="3" class="base-action-btn w-full text-lg font-medium py-4 px-6 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors">Send to 3rd</button>
                <button data-action="score" class="base-action-btn w-full text-lg font-medium py-4 px-6 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">Runner Scored</button>
                <button data-action="out" class="base-action-btn w-full text-lg font-medium py-4 px-6 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Runner Out</button>
                <button data-action="cancel" class="base-action-btn w-full mt-4 py-2 px-4 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
            </div>
        </div>
        
        <div id="base-context-modal-3" class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full hidden">
            <h2 class="text-xl font-bold text-center mb-6">Runner on 3rd</h2>
            <p class="text-center text-gray-700 mb-6">What happened to this runner?</p>
            <div class="space-y-4">
                <button data-action="score" class="base-action-btn w-full text-lg font-medium py-4 px-6 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">Runner Scored</button>
                <button data-action="out" class="base-action-btn w-full text-lg font-medium py-4 px-6 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Runner Out</button>
                <button data-action="cancel" class="base-action-btn w-full mt-4 py-2 px-4 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
            </div>
        </div>

        <!-- "Force Out" Modal -->
        <div id="force-out-modal" class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full hidden">
            <h2 class="text-xl font-bold text-center mb-6">3rd Out Recorded</h2>
            <p class="text-center text-gray-700 mb-6">A run scored on the same play. Was the 3rd out a <span class="font-bold">force out</span>?</p>
            <div class="flex space-x-4">
                <button id="force-out-yes" class="w-full text-lg font-medium py-4 px-6 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    Yes, Force Out<br><span class="text-sm font-normal">(Run does NOT count)</span>
                </button>
                <button id="force-out-no" class="w-full text-lg font-medium py-4 px-6 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    No, Not a Force Out<br><span class="text-sm font-normal">(Run counts)</span>
                </button>
            </div>
        </div>
        
        <!-- "End Game" Confirmation Modal -->
        <div id="end-game-modal" class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full hidden">
            <h2 class="text-xl font-bold text-center mb-6">End Game?</h2>
            <p class="text-center text-gray-700 mb-6">This will reset scores and the game log, but keep your roster and lineup. Are you sure?</p>
            <div class="flex space-x-4">
                <button id="end-game-yes" class="w-full text-lg font-medium py-4 px-6 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    Yes, End Game
                </button>
                <button id="end-game-no" class="w-full text-lg font-medium py-4 px-6 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
            </div>
        </div>

    </div>

    <!-- Main Content -->
    <div class="flex flex-col md:flex-row md:h-screen md:overflow-hidden">
        
        <!-- Left Column -->
        <div class="w-full md:w-1/2 p-4 flex flex-col h-auto md:h-full overflow-y-auto bg-white shadow-lg z-10">
            
            <div class="mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-bold text-gray-800">Roster Management</h2>
                    <button id="roster-toggle-btn" class="px-3 py-1 text-lg font-bold bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">-</button>
                </div>
                <div id="roster-toggle-content">
                    <form id="add-player-form" class="bg-gray-50 p-4 rounded-lg shadow-inner space-y-3 mb-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" id="player-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Number</label>
                                <input type="text" id="player-number" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Position</label>
                            <input type="text" id="player-position" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Gender</label>
                            <div class="mt-1 flex space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" id="gender-male" name="gender" value="male" checked>
                                    <span class="ml-2 text-sm text-gray-700">Male</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" id="gender-female" name="gender" value="female">
                                    <span class="ml-2 text-sm text-gray-700">Female</span>
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-blue-600 hover:bg-blue-700">
                            Add Player to Roster
                        </button>
                    </form>
                    
                    <div class="flex-shrink-0">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">My Team Roster</h3>
                        <div id="roster-list" class="bg-gray-100 p-3 rounded-lg min-h-[100px] shadow-inner space-y-2"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex-grow flex flex-col min-h-0">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Today's Batting Order</h3>
                
                <div id="traditional-order-container" class="flex-grow flex flex-col min-h-0">
                    <div id="batting-order-list" class="bg-gray-100 p-3 rounded-lg shadow-inner flex-grow min-h-[150px] space-y-2 overflow-y-auto"></div>
                    <p id="order-warning" class="text-red-600 text-sm font-medium text-center mt-2 hidden">Batting order must alternate male/female.</p>
                </div>

                <div id="wheel-order-container" class="hidden flex-grow md:grid md:grid-cols-2 md:gap-4 min-h-0">
                    <div class="flex flex-col min-h-0">
                        <h4 class="text-md font-semibold text-center text-blue-700 mb-2">Males</h4>
                        <div id="batting-order-list-male" class="bg-blue-50 p-3 rounded-lg shadow-inner flex-grow overflow-y-auto space-y-2"></div>
                    </div>
                    <div class="flex flex-col min-h-0">
                        <h4 class="text-md font-semibold text-center text-pink-700 mb-2">Females</h4>
                        <div id="batting-order-list-female" class="bg-pink-50 p-3 rounded-lg shadow-inner flex-grow overflow-y-auto space-y-2"></div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-bold text-gray-800">Game Log</h2>
                    <button id="game-log-toggle-btn" class="px-3 py-1 text-lg font-bold bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">+</button>
                </div>
                <div id="game-log-toggle-content" style="max-height: 0px; opacity: 0;">
                    <!-- Drag Handle (New) -->
                    <div id="game-log-resize-handle" class="resize-handle w-full h-4 bg-gray-200 cursor-row-resize flex justify-center items-center hover:bg-gray-300 mb-1 rounded-t-md">
                         <div class="w-8 h-1 bg-gray-400 rounded-full"></div>
                    </div>
                    <!-- Fixed: Removed max-h-[200px] class, added style="height: 200px;" -->
                    <div id="game-log-list" class="bg-gray-100 p-3 rounded-lg shadow-inner space-y-2 overflow-y-auto text-sm" style="height: 200px;"></div>
                </div>
            </div>

            <p class="text-xs text-gray-400 mt-2 text-center">User ID: <span id="user-id" class="font-mono">loading...</span></p>
        </div>
        
        <!-- Right Column -->
        <div class="w-full md:w-1/2 p-4 flex flex-col h-auto md:h-full">
            <div class="w-full md:h-1/3 flex flex-col md:flex-row gap-4 mb-4">
                <div class="w-full md:w-1/2 bg-white rounded-lg shadow-xl p-4">
                    <div class="grid grid-cols-3 gap-2 mb-3 text-center items-center mt-2">
                        <div>
                            <div id="home-label" class="text-md font-semibold text-blue-700">HOME</div>
                            <div id="home-score" class="text-4xl font-bold text-blue-700">0</div>
                        </div>
                        <div id="inning-toggle" class="cursor-pointer">
                            <div class="text-xs font-medium text-gray-500">INNING</div>
                            <div class="flex items-center space-x-1 justify-center">
                                <div id="inning" class="text-2xl font-semibold">1</div>
                                <span id="inning-indicator" class="text-3xl font-bold text-gray-700">&uarr;</span>
                            </div>
                        </div>
                        <div>
                            <div id="away-label" class="text-md font-semibold text-gray-500">AWAY</div>
                            <div id="away-score" class="text-4xl font-bold text-gray-700">0</div>
                        </div>
                    </div>
                    <div class="p-3 bg-gray-100 rounded-lg">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <div>
                                    <div class="text-xs font-medium text-gray-500 uppercase">Balls</div>
                                    <div class="flex space-x-1 mt-1">
                                        <span class="ball w-4 h-4 bg-gray-300 rounded-full"></span>
                                        <span class="ball w-4 h-4 bg-gray-300 rounded-full"></span>
                                        <span class="ball w-4 h-4 bg-gray-300 rounded-full"></span>
                                        <span class="ball w-4 h-4 bg-gray-300 rounded-full"></span>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs font-medium text-gray-500 uppercase">Strikes</div>
                                    <div class="flex space-x-1 mt-1">
                                        <span class="strike w-4 h-4 bg-gray-300 rounded-full"></span>
                                        <span class="strike w-4 h-4 bg-gray-300 rounded-full"></span>
                                        <span class="strike w-4 h-4 bg-gray-300 rounded-full"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <div>
                                    <div class="text-xs font-medium text-gray-500 uppercase">Outs</div>
                                    <div class="flex space-x-1 mt-1">
                                        <span class="out w-4 h-4 bg-gray-300 rounded-full cursor-pointer"></span>
                                        <span class="out w-4 h-4 bg-gray-300 rounded-full cursor-pointer"></span>
                                        <span class="out w-4 h-4 bg-gray-300 rounded-full cursor-pointer"></span>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs font-medium text-gray-500 uppercase">Runs</div>
                                    <div id="runs-this-inning" class="text-xl font-semibold text-green-600">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="w-full md:w-1/2 bg-white rounded-lg shadow-xl p-4 flex flex-col justify-between">
                    <div class="grid grid-cols-3 gap-2">
                        <button id="btn-walk" class="py-2 text-white bg-blue-600 rounded-lg">Walk</button>
                        <button id="btn-hit" class="py-2 text-white bg-green-600 rounded-lg">Hit</button>
                        <button id="btn-out" class="py-2 text-white bg-red-600 rounded-lg">Out</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <button id="btn-add-ball" class="py-2 text-white bg-blue-500 rounded-lg text-xs">Add Ball</button>
                        <button id="btn-add-strike" class="py-2 text-white bg-red-500 rounded-lg text-xs">Add Strike</button>
                    </div>
                    <button id="btn-end-game" class="w-full mt-2 py-2 text-white bg-gray-700 rounded-lg">End Game</button>
                </div>
            </div>
            
            <div class="w-full md:h-2/3 flex-grow min-h-0 flex items-center justify-center bg-white rounded-lg shadow-xl p-4 overflow-hidden relative">
                <div class="w-full h-full relative">
                    <div class="baseball-diamond absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <path d="M 50 10 L 90 50 L 50 90 L 10 50 Z" fill="#689f38" stroke="#a5d6a7" stroke-width="1"/>
                            <path d="M 50 90 L 90 50 L 50 10 L 10 50 Z" fill="none" stroke="#d2b48c" stroke-width="2"/>
                            <circle cx="50" cy="50" r="8" fill="#d2b48c" opacity="0.6"/>
                        </svg>
                        <div id="home-plate" class="base"><svg viewBox="0 0 100 100" class="base-icon" fill="#e0e0e0"><path d="M 10 10 L 90 10 L 90 50 L 50 90 L 10 50 Z"/></svg><span class="base-label">Home</span><span class="base-runner-name"></span></div>
                        <div id="first-base" class="base"><svg viewBox="0 0 100 100" class="base-icon" fill="#e0e0e0"><path d="M 50 0 L 100 50 L 50 100 L 0 50 Z"/></svg><span class="base-label">First</span><span class="base-runner-name"></span></div>
                        <div id="second-base" class="base"><svg viewBox="0 0 100 100" class="base-icon" fill="#e0e0e0"><path d="M 50 0 L 100 50 L 50 100 L 0 50 Z"/></svg><span class="base-label">Second</span><span class="base-runner-name"></span></div>
                        <div id="third-base" class="base"><svg viewBox="0 0 100 100" class="base-icon" fill="#e0e0e0"><path d="M 50 0 L 100 50 L 50 100 L 0 50 Z"/></svg><span class="base-label">Third</span><span class="base-runner-name"></span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Config ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBN9HfXy4k2HIVGklUtk5fMA8yyX9RZH2g",
            authDomain: "softball-scorecard.firebaseapp.com",
            projectId: "softball-scorecard",
            storageBucket: "softball-scorecard.firebasestorage.app",
            messagingSenderId: "749570093852",
            appId: "1:749570093852:web:d1f4ad5e1261637dfd40d9",
            measurementId: "G-27TEBB943P"
        };
        const appId = firebaseConfig.projectId;
        
        // --- Firebase Imports ---
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc,
            getDoc,
            addDoc,
            updateDoc,
            deleteDoc, 
            onSnapshot, 
            collection, 
            query,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Helper Functions Moved to Top ---
        function showModal(el) {
            DOMElements.modalOverlay.classList.remove('hidden');
            [...DOMElements.modalOverlay.children].forEach(c => c.classList.add('hidden'));
            el.classList.remove('hidden');
        }

        function hideAllModals() {
            DOMElements.modalOverlay.classList.add('hidden');
        }

        // --- Firebase Initialization ---
        let app, db, auth, userId, rosterCollectionRef;
        let unsubscribeRoster = () => {}; 
        
        // --- Drag & Drop Variables ---
        let draggedItem = null;
        let dragSourceListId = null;

        // --- App State ---
        let gameState = {
            homeScore: 0,
            awayScore: 0,
            inning: 1,
            topOfInning: true,
            balls: 1,
            strikes: 1,
            outs: 0,
            runsThisInning: 0,
            runsThisPlay: 0,
            runnerInningCounter: 0,
            bases: { 1: null, 2: null, 3: null },
            roster: [],
            battingOrder: { traditional: [], male: [], female: [] },
            currentBatterIndex: { traditional: 0, male: 0, female: 0 },
            gameMode: null,
            userTeam: null,
            nextToBat: null,
            rosterMinimized: false,
            gameLogMinimized: true,
            gameLog: [],
            gameLogHeight: 200 // Default height
        };
        const RUN_LIMIT = 6;
        const RUN_LIMIT_INNING = 5;
        const STARTING_BALLS = 1;
        const STARTING_STRIKES = 1;

        // --- DOM Elements ---
        const DOMElements = {
            homeScore: document.getElementById('home-score'),
            awayScore: document.getElementById('away-score'),
            homeLabel: document.getElementById('home-label'),
            awayLabel: document.getElementById('away-label'),
            inning: document.getElementById('inning'),
            inningIndicator: document.getElementById('inning-indicator'),
            inningToggle: document.getElementById('inning-toggle'),
            runsThisInning: document.getElementById('runs-this-inning'),
            balls: document.querySelectorAll('.ball'),
            strikes: document.querySelectorAll('.strike'),
            outs: document.querySelectorAll('.out'),
            bases: {
                1: document.getElementById('first-base'),
                2: document.getElementById('second-base'),
                3: document.getElementById('third-base')
            },
            baseRunners: {
                1: document.querySelector('#first-base .base-runner-name'),
                2: document.querySelector('#second-base .base-runner-name'),
                3: document.querySelector('#third-base .base-runner-name')
            },
            btnWalk: document.getElementById('btn-walk'),
            btnHit: document.getElementById('btn-hit'),
            btnOut: document.getElementById('btn-out'),
            btnEndGame: document.getElementById('btn-end-game'),
            btnAddBall: document.getElementById('btn-add-ball'),
            btnAddStrike: document.getElementById('btn-add-strike'),
            rosterList: document.getElementById('roster-list'),
            addPlayerForm: document.getElementById('add-player-form'),
            playerNameInput: document.getElementById('player-name'),
            playerNumberInput: document.getElementById('player-number'),
            playerPositionInput: document.getElementById('player-position'),
            genderMaleInput: document.getElementById('gender-male'),
            genderFemaleInput: document.getElementById('gender-female'),
            battingOrderList: document.getElementById('batting-order-list'),
            battingOrderListMale: document.getElementById('batting-order-list-male'),
            battingOrderListFemale: document.getElementById('batting-order-list-female'),
            orderWarning: document.getElementById('order-warning'),
            traditionalContainer: document.getElementById('traditional-order-container'),
            wheelOrderContainer: document.getElementById('wheel-order-container'),
            modalOverlay: document.getElementById('modal-overlay'),
            gameModeModal: document.getElementById('game-mode-modal'),
            whoBatsFirstModal: document.getElementById('who-bats-first-modal'),
            userTeamModal: document.getElementById('user-team-modal'),
            hitTypeModal: document.getElementById('hit-type-modal'),
            baseContextModal1: document.getElementById('base-context-modal-1'),
            baseContextModal2: document.getElementById('base-context-modal-2'),
            baseContextModal3: document.getElementById('base-context-modal-3'),
            forceOutModal: document.getElementById('force-out-modal'),
            forceOutYesBtn: document.getElementById('force-out-yes'),
            forceOutNoBtn: document.getElementById('force-out-no'),
            endGameModal: document.getElementById('end-game-modal'),
            endGameYesBtn: document.getElementById('end-game-yes'),
            endGameNoBtn: document.getElementById('end-game-no'),
            modeTraditionalBtn: document.getElementById('mode-traditional'),
            modeWheelBtn: document.getElementById('mode-wheel'),
            startMaleBtn: document.getElementById('start-male'),
            startFemaleBtn: document.getElementById('start-female'),
            teamHomeBtn: document.getElementById('team-home'),
            teamAwayBtn: document.getElementById('team-away'),
            userIdDisplay: document.getElementById('user-id'),
            rosterToggleBtn: document.getElementById('roster-toggle-btn'),
            rosterToggleContent: document.getElementById('roster-toggle-content'),
            gameLogToggleBtn: document.getElementById('game-log-toggle-btn'),
            gameLogToggleContent: document.getElementById('game-log-toggle-content'),
            gameLogList: document.getElementById('game-log-list'),
            baseActionButtons: document.querySelectorAll('.base-action-btn'),
            hitTypeButtons: document.querySelectorAll('.hit-type-btn'),
            cancelHitButton: document.getElementById('cancel-hit'),
            gameLogResizeHandle: document.getElementById('game-log-resize-handle') // For Resize
        };
        
        // --- Game Log Functions ---
        function addLogEntry(message, type = 'info') {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const entry = document.createElement('div');
            entry.className = 'p-2 rounded bg-white shadow-sm';
            let colorClass = 'text-gray-700';
            if (type === 'run') colorClass = 'text-green-600 font-medium';
            if (type === 'out') colorClass = 'text-red-600 font-medium';
            if (type === 'inning') colorClass = 'text-blue-600 font-bold';
            entry.innerHTML = `<span class="font-mono text-xs text-gray-500">[${time}]</span> <span class="${colorClass}">${message}</span>`;
            DOMElements.gameLogList.prepend(entry);
        }

        function handleGameLogToggle() {
            gameState.gameLogMinimized = !gameState.gameLogMinimized;
            if (gameState.gameLogMinimized) {
                DOMElements.gameLogToggleContent.style.maxHeight = '0px';
                DOMElements.gameLogToggleContent.style.opacity = '0';
                DOMElements.gameLogToggleContent.style.marginTop = '0';
                DOMElements.gameLogToggleBtn.textContent = '+';
            } else {
                // Set max-height large enough to hold current log height + handle
                DOMElements.gameLogToggleContent.style.maxHeight = (gameState.gameLogHeight + 50) + 'px'; 
                DOMElements.gameLogToggleContent.style.opacity = '1';
                DOMElements.gameLogToggleContent.style.marginTop = '';
                DOMElements.gameLogToggleBtn.textContent = '-';
            }
        }
        
        // --- Game Log Resize Logic ---
        function setupGameLogResize() {
            let startY, startHeight;
            const handle = DOMElements.gameLogResizeHandle;
            const list = DOMElements.gameLogList;

            const onDragStart = (y) => {
                startY = y;
                startHeight = parseInt(getComputedStyle(list).height, 10);
                document.addEventListener('mousemove', onDragging);
                document.addEventListener('mouseup', onDragEnd);
                document.addEventListener('touchmove', onTouchDragging, { passive: false });
                document.addEventListener('touchend', onDragEnd);
                document.body.style.cursor = 'row-resize';
            };

            const onDragging = (e) => {
                // Drag UP (negative delta) increases height
                const delta = startY - e.clientY;
                const newHeight = Math.max(100, Math.min(600, startHeight + delta)); // Min 100px, Max 600px
                gameState.gameLogHeight = newHeight;
                list.style.height = newHeight + 'px';
                // Update wrapper if open so it doesn't clip
                if (!gameState.gameLogMinimized) {
                    DOMElements.gameLogToggleContent.style.maxHeight = (newHeight + 50) + 'px';
                }
            };
            
            const onTouchDragging = (e) => {
                e.preventDefault(); // Prevent scrolling
                const touch = e.touches[0];
                const delta = startY - touch.clientY;
                const newHeight = Math.max(100, Math.min(600, startHeight + delta));
                gameState.gameLogHeight = newHeight;
                list.style.height = newHeight + 'px';
                 if (!gameState.gameLogMinimized) {
                    DOMElements.gameLogToggleContent.style.maxHeight = (newHeight + 50) + 'px';
                }
            };

            const onDragEnd = () => {
                document.removeEventListener('mousemove', onDragging);
                document.removeEventListener('mouseup', onDragEnd);
                document.removeEventListener('touchmove', onTouchDragging);
                document.removeEventListener('touchend', onDragEnd);
                document.body.style.cursor = '';
            };

            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                onDragStart(e.clientY);
            });
            handle.addEventListener('touchstart', (e) => {
                // e.preventDefault(); // Don't prevent default on start, only move
                onDragStart(e.touches[0].clientY);
            });
        }


        // --- UI Update Functions ---
        
        function updateScoreboard() {
            DOMElements.homeScore.textContent = gameState.homeScore;
            DOMElements.awayScore.textContent = gameState.awayScore;
            DOMElements.inning.textContent = gameState.inning;
            DOMElements.runsThisInning.textContent = gameState.runsThisInning;
            DOMElements.inningIndicator.innerHTML = gameState.topOfInning ? '&uarr;' : '&darr;';
            DOMElements.inningIndicator.className = `text-3xl font-bold ${gameState.topOfInning ? 'text-gray-700' : 'text-blue-700'}`;
            
            // Highlight user's team label
            DOMElements.homeLabel.classList.toggle('ring-2', gameState.userTeam === 'home');
            DOMElements.homeLabel.classList.toggle('ring-yellow-400', gameState.userTeam === 'home');
            DOMElements.awayLabel.classList.toggle('ring-2', gameState.userTeam === 'away');
            DOMElements.awayLabel.classList.toggle('ring-yellow-400', gameState.userTeam === 'away');


            updateCounter(DOMElements.balls, gameState.balls, 'bg-yellow-400');
            updateCounter(DOMElements.strikes, gameState.strikes, 'bg-red-500');
            updateCounter(DOMElements.outs, gameState.outs, 'bg-red-500');
        }

        function updateCounter(elements, count, activeClass) {
            elements.forEach((el, idx) => {
                el.classList.toggle(activeClass, idx < count);
                el.classList.toggle('bg-gray-300', idx >= count);
            });
        }

        function updateBases() {
            for (let i = 1; i <= 3; i++) {
                const runner = gameState.bases[i];
                // --- DYNAMIC NUMBERING: Calculate runner label relative to runs scored ---
                let runnersAhead = 0;
                for (let b = i + 1; b <= 3; b++) {
                     if (gameState.bases[b]) runnersAhead++;
                }
                
                const dynamicNumber = gameState.runsThisInning + 1 + runnersAhead;
                
                DOMElements.bases[i].classList.toggle('active', !!runner);
                // Use calculated dynamicNumber instead of stored displayOrder
                DOMElements.baseRunners[i].textContent = runner ? `${dynamicNumber} - ${runner.name}` : '';
            }
        }
        
        function getAllRunners() {
            const runners = [];
            if (gameState.bases[1]) runners.push(gameState.bases[1]);
            if (gameState.bases[2]) runners.push(gameState.bases[2]);
            if (gameState.bases[3]) runners.push(gameState.bases[3]);
            return runners;
        }

        function clearBases() {
            gameState.bases = { 1: null, 2: null, 3: null };
            updateBases();
        }

        function resetCounts() {
            gameState.balls = STARTING_BALLS;
            gameState.strikes = STARTING_STRIKES;
            // The runsThisPlay is intentionally NOT reset here, only in advanceHalfInning
            updateScoreboard();
        }
        
        // --- NEW Force Out Logic ---
        function handleForceOut(wasForceOut) {
            hideAllModals();
            if (wasForceOut) {
                // Negate the runs scored *this play*
                const runsToNegate = gameState.runsThisPlay;
                if (runsToNegate > 0) {
                    addLogEntry(`Runs negated due to force out (-${runsToNegate} run${runsToNegate > 1 ? 's' : ''}).`, 'out');
                    gameState.runsThisInning -= runsToNegate;
                    if (gameState.topOfInning) {
                        gameState.awayScore -= runsToNegate;
                    } else {
                        gameState.homeScore -= runsToNegate;
                    }
                }
            }
            // Whether it was a force out or not, the inning is now over.
            advanceHalfInning();
        }
        // --- End Force Out Logic ---


        function advanceHalfInning() {
            const currentTeam = gameState.topOfInning ? 'Away' : 'Home';
            addLogEntry(`--- ${currentTeam} team 3 outs. ---`, 'inning');
            
            // --- CRITICAL FIX 1: Advance batter index for the next half-inning ---
            handleNextBatter(true); // Advance batter index only, skip count reset
            
            gameState.outs = 0;
            gameState.runsThisInning = 0;
            gameState.runnerInningCounter = 0; // Reset for new half-inning
            gameState.runsThisPlay = 0; // --- RESET runsThisPlay HERE ONLY ---
            
            if (gameState.topOfInning) {
                // Top of inning ends, switch to bottom
                gameState.topOfInning = false;
                addLogEntry(`Start Bottom of Inning ${gameState.inning}.`, 'inning');
            } else {
                // Bottom of inning ends, switch to next inning
                gameState.topOfInning = true;
                gameState.inning++;
                addLogEntry(`Start Top of Inning ${gameState.inning}.`, 'inning');
            }
            clearBases();
            resetCounts(); // Resets to 1-1
            updateScoreboard();
            highlightCurrentBatter(); // Highlight batter for the new half-inning
        }

        /**
         * Adds an out to the game state.
         * @returns {boolean} Returns true if this was the 3rd out, false otherwise.
         */
        function addOut(logMessage = 'Out recorded.') {
            let isThirdOut = false; // Flag
            if (gameState.outs < 2) {
                gameState.outs++;
                addLogEntry(logMessage, 'out');
                updateScoreboard();
            } else {
                // 3rd out
                addLogEntry(logMessage, 'out');
                isThirdOut = true; // Set flag
                updateScoreboard(); // Show 3 outs briefly
                
                // --- NEW Force Out Check ---
                if (gameState.runsThisPlay > 0) {
                    // A run scored on the 3rd out play, ask if it was a force out
                    setTimeout(() => { // Delay to let user see the 3rd out
                        showModal(DOMElements.forceOutModal);
                    }, 500);
                } else {
                    // No runs on the play, just advance the inning
                    setTimeout(() => {
                        advanceHalfInning();
                    }, 500);
                }
            }
            return isThirdOut; // Return if it was the 3rd out
        }

        function addRuns(numRuns, batterName = 'Runner', isManual = false) {
            if (numRuns <= 0) return;
            
            // Only log if it's a manual score or a forced-in run
            if(isManual) {
                addLogEntry(`${batterName} scores! (+${numRuns} run${numRuns > 1 ? 's' : ''})`, 'run');
            }

            gameState.runsThisPlay += numRuns; // Track for force out
            gameState.runsThisInning += numRuns;
            if (gameState.topOfInning) {
                gameState.awayScore += numRuns;
            } else {
                gameState.homeScore += numRuns;
            }

            // Check for run limit
            if (gameState.inning <= RUN_LIMIT_INNING && gameState.runsThisInning >= RUN_LIMIT) {
                // Reached run limit, advance inning
                const overage = gameState.runsThisInning - RUN_LIMIT;
                if (overage > 0) {
                    if (gameState.topOfInning) {
                        gameState.awayScore -= overage;
                    } else {
                        gameState.homeScore -= overage;
                    }
                    addLogEntry(`Run limit of ${RUN_LIMIT} reached. (-${overage} run${overage > 1 ? 's' : ''})`, 'info');
                }
                gameState.runsThisInning = RUN_LIMIT;
                
                updateScoreboard();
                updateBases(); // Show final base state
                
                // Use a short delay so user can see the final play
                setTimeout(() => {
                    advanceHalfInning();
                }, 1500);
            } else {
                updateScoreboard();
            }
        }

        function getCurrentBatter() {
            let batter = null;
            if (gameState.gameMode === 'traditional') {
                const list = gameState.battingOrder.traditional;
                const index = gameState.currentBatterIndex.traditional;
                if (list.length > 0) {
                    batter = list[index % list.length];
                }
            } else if (gameState.gameMode === 'wheel') {
                if (gameState.nextToBat === 'male') {
                    const list = gameState.battingOrder.male;
                    const index = gameState.currentBatterIndex.male;
                    if (list.length > 0) {
                        batter = list[index % list.length];
                    }
                } else {
                    const list = gameState.battingOrder.female;
                    const index = gameState.currentBatterIndex.female;
                    if (list.length > 0) {
                        batter = list[index % list.length];
                    }
                }
            }
            return batter;
        }

        // --- Helper to check if it's the user's team at bat ---
        function isUserTeamAtBat() {
            const isHomeBatting = !gameState.topOfInning;
            const userIsHome = gameState.userTeam === 'home';
            return isHomeBatting === userIsHome;
        }

        function getBatterName(batter) {
            // If it's not the user's team at bat, return "Away".
            if (!isUserTeamAtBat()) return "Away";
            // Otherwise, use the batter's name
            return batter ? batter.name.split(' ')[0] : "Batter";
        }

        // --- RUNNER NUMBERING FIX ---
        function getNextRunnerDisplayOrder() {
            // This is the number of batters who have COME to the plate this inning
            return gameState.runnerInningCounter + 1;
        }
        
        function createNewRunner(batter) {
            gameState.runnerInningCounter++; // This is the *original* number
            const batterName = getBatterName(batter);
            // Display order IS the inning counter
            const displayOrder = gameState.runnerInningCounter; 

            return {
                name: batterName,
                originalNumber: gameState.runnerInningCounter,
                displayOrder: displayOrder
            };
        }
        // --- END RUNNER NUMBERING FIX ---
        
        function advanceRunnersOnWalk(batter) {
            const batterName = getBatterName(batter);
            addLogEntry(`${batterName} walks.`, 'info');
            
            const newRunner = createNewRunner(batter);
            let runsScored = 0;
            let scoredRunnerName = 'Runner';
            
            // Check gender *only* if it's the user's team
            const isMale = isUserTeamAtBat() && batter && batter.gender === 'male';

            // --- Standard Walk Logic (Force runners) ---
            if (gameState.bases[1] && gameState.bases[2] && gameState.bases[3]) { // Bases loaded
                runsScored++; // Runner from 3rd scores
                scoredRunnerName = gameState.bases[3].name;
                gameState.bases[3] = gameState.bases[2];
                gameState.bases[2] = gameState.bases[1];
                gameState.bases[1] = newRunner;
            } else if (gameState.bases[1] && gameState.bases[2]) { // Runners on 1st and 2nd
                gameState.bases[3] = gameState.bases[2];
                gameState.bases[2] = gameState.bases[1];
                gameState.bases[1] = newRunner;
            } else if (gameState.bases[1]) { // Runner on 1st only
                gameState.bases[2] = gameState.bases[1];
                gameState.bases[1] = newRunner;
            } else { // No force
                gameState.bases[1] = newRunner;
            }
            
            // --- Co-Ed Male Walk Rule: Advance to 2nd (if they are on 1st) ---
            if (isMale && gameState.bases[1] === newRunner) {
                addLogEntry(`Male walk rule: ${batterName} advances to 2nd.`, 'info');
                // Batter is on 1st, advance them to 2nd (no force)
                if (gameState.bases[2]) {
                    // 2nd is occupied, advance 2nd to 3rd (no force)
                    if (gameState.bases[3]) {
                        // 3rd is occupied, advance 3rd home (no force)
                        runsScored++;
                        scoredRunnerName = gameState.bases[3].name;
                    }
                    gameState.bases[3] = gameState.bases[2];
                }
                gameState.bases[2] = gameState.bases[1]; // Move batter to 2nd
                gameState.bases[1] = null; // Vacate 1st
            }

            if (runsScored > 0) {
                addRuns(runsScored, scoredRunnerName, true); // This is a forced-in run, log it
            }
            updateBases();
        }
        
        // --- NEW HIT "PUSH" LOGIC ---
        function advanceRunnersOnHit(batter, hitType) {
            const batterName = getBatterName(batter);
            const hitNames = ['Single', 'Double', 'Triple', 'Home Run'];
            addLogEntry(`${batterName} hits a ${hitNames[hitType - 1]}!`, 'info');

            hideAllModals();
            
            const newRunner = createNewRunner(batter);
            const scoredRunners = [];

            // --- RE-FIXED PUSH LOGIC ---
            let runsFromPush = 0;
            const scoredFromPush = [];
            const finalBases = { 1: null, 2: null, 3: null };

            // 1. Handle Home Run: Clear all bases and score everyone
            if (hitType === 4) {
                for (let baseNum = 3; baseNum >= 1; baseNum--) {
                    if (gameState.bases[baseNum]) {
                        runsFromPush++;
                        scoredFromPush.push(gameState.bases[baseNum].name);
                    }
                    gameState.bases[baseNum] = null; // Clear base
                }
                runsFromPush++;
                scoredFromPush.push(newRunner.name); // Batter scores
                gameState.bases = { 1: null, 2: null, 3: null }; // Ensure clear state
                
            } else {
                 // Place batter first on their hit base
                finalBases[hitType] = newRunner;

                // Process existing runners from 3rd down to 1st
                // Only advance a runner if their base or the one they are forced to is taken by the "push" coming from behind
                
                // Let's model this as a chain reaction from the batter.
                // Batter lands on [hitType].
                // IF [hitType] was occupied, THAT runner is pushed to [hitType + 1].
                // IF [hitType + 1] was occupied, THAT runner is pushed to [hitType + 2].
                // ...and so on.

                let currentPusher = newRunner;
                let currentPusherBase = hitType;

                // We need to know who was where originally
                const originalRunners = { ...gameState.bases };

                // Recursive push function
                function pushRunner(baseToOccupy, pushingRunner) {
                     // Check if someone is currently at baseToOccupy
                     const occupant = originalRunners[baseToOccupy];
                     
                     // Place the pusher
                     finalBases[baseToOccupy] = pushingRunner;
                     
                     // If there was an occupant, they are forced to next base
                     if (occupant) {
                         const nextBase = baseToOccupy + 1;
                         if (nextBase > 3) {
                             runsFromPush++;
                             scoredFromPush.push(occupant.name);
                         } else {
                             pushRunner(nextBase, occupant);
                         }
                     }
                }
                
                // BUT wait, that logic is for a Walk (force).
                // On a HIT, the rule is:
                // 1. Batter is placed at [hitType].
                // 2. IF a runner was at [hitType] OR was pushed into it, they move forward.
                // 3. Runners AHEAD of the push who are NOT forced stay put (unless you manually move them).
                
                // Example: Runner on 2nd. Batter hits Single (to 1st).
                // Batter -> 1st.
                // Runner at 2nd is NOT forced by 1st. Stays at 2nd.
                // Correct.
                
                // Example: Runner on 1st. Batter hits Single (to 1st).
                // Batter -> 1st.
                // Runner at 1st is forced to 2nd.
                // Runner at 2nd (if any) is forced to 3rd.
                
                // Let's implement this logic:
                // We start with the batter at `hitType`.
                // We check `originalRunners[hitType]`. If exists, they must move to `hitType+1`.
                // We check `originalRunners[hitType+1]`. If exists AND we are pushing into it, they move to `hitType+2`.
                
                // Copy non-forced runners to finalBases first
                for(let b=1; b<=3; b++) {
                    if (originalRunners[b] && b > hitType) {
                         // Runners ahead of the hit who are not immediately displaced *might* stay put.
                         // We will overwrite them if a push comes through.
                         finalBases[b] = originalRunners[b];
                    }
                }
                
                // Start the push chain
                let runnerBeingPushed = null;
                let baseToPushTo = null;
                
                // 1. Batter takes base
                // Check who is displaced
                if (originalRunners[hitType]) {
                    runnerBeingPushed = originalRunners[hitType];
                    baseToPushTo = hitType + 1;
                }
                finalBases[hitType] = newRunner;
                
                // 2. Resolve push chain
                while (runnerBeingPushed) {
                    if (baseToPushTo > 3) {
                        runsFromPush++;
                        scoredFromPush.push(runnerBeingPushed.name);
                        runnerBeingPushed = null; // Scored
                    } else {
                        // Check if someone is at the next base
                        const nextOccupant = originalRunners[baseToPushTo];
                        
                        // Place pushed runner
                        finalBases[baseToPushTo] = runnerBeingPushed;
                        
                        if (nextOccupant) {
                            // Continue chain
                            runnerBeingPushed = nextOccupant;
                            baseToPushTo++;
                        } else {
                            // Chain ends
                            runnerBeingPushed = null;
                        }
                    }
                }
            }
            // --- END RE-FIXED PUSH LOGIC ---

            gameState.bases = finalBases;

            if (runsFromPush > 0) {
                // Log runs one by one
                scoredFromPush.forEach(name => addRuns(1, name, true));
            }
            updateBases();
            handleNextBatter();
        }
        // --- END NEW HIT LOGIC ---


        // --- Roster & Batting Order UI ---

        function createPlayerCard(player) {
            const card = document.createElement('div');
            card.className = 'roster-card bg-white p-2 rounded-md shadow-sm flex justify-between items-center';
            card.dataset.id = player.id;
            card.dataset.gender = player.gender;
            card.dataset.playerData = JSON.stringify(player);
            card.draggable = true;

            const genderIcon = player.gender === 'male' 
                ? `<span class="font-bold text-blue-600">(M)</span>` 
                : `<span class="font-bold text-pink-600">(F)</span>`;
            
            // Format: (15)
            const num = player.number ? `(${player.number})` : '';
            // Format: LC - 
            const pos = player.position ? `${player.position} - ` : '';
            
            // Layout: (M) LC - Jarred (15)
            card.innerHTML = `
                <span class="font-medium text-sm text-gray-800">${genderIcon} ${pos}${player.name} ${num}</span>
                <div class="flex space-x-1">
                    <button data-id="${player.id}" class="add-player-to-order text-green-600 hover:text-green-800 font-bold text-lg px-2 rounded-md hover:bg-green-100" title="Add to batting order">+</button>
                    <button data-id="${player.id}" class="remove-player text-red-500 hover:text-red-700 font-bold text-lg px-2 rounded-md hover:bg-red-100" title="Remove from roster">&times;</button>
                </div>
            `;
            return card;
        }

        function renderRoster() {
            DOMElements.rosterList.innerHTML = '';
            gameState.roster.forEach(player => {
                const card = createPlayerCard(player);
                // Only roster list cards should have remove/add buttons
                card.querySelector('.remove-player').addEventListener('click', handleRemovePlayer);
                card.querySelector('.add-player-to-order').addEventListener('click', handleAddPlayerToOrder);
                
                // --- NEW LOGIC: Hide + if in lineup ---
                const inTraditional = gameState.battingOrder.traditional.find(p => p.id === player.id);
                const inMale = gameState.battingOrder.male.find(p => p.id === player.id);
                const inFemale = gameState.battingOrder.female.find(p => p.id === player.id);
                const addButton = card.querySelector('.add-player-to-order');
                
                if (inTraditional || inMale || inFemale) {
                    addButton.style.display = 'none'; // Hide the + button
                } else {
                    addButton.style.display = 'inline-block'; // Show
                }
                // --- END NEW LOGIC ---
                
                DOMElements.rosterList.appendChild(card);
            });
        }

        function createBattingOrderCard(player) {
            const card = document.createElement('div');
            // Use the same class structure as roster card for consistency
            card.className = 'roster-card bg-white p-2 rounded-md shadow-sm flex justify-between items-center'; 
            card.dataset.id = player.id;
            card.dataset.gender = player.gender;
            card.dataset.playerData = JSON.stringify(player);
            card.draggable = true;

            const genderIcon = player.gender === 'male' 
                ? `<span class="font-bold text-blue-600">(M)</span>` 
                : `<span class="font-bold text-pink-600">(F)</span>`;
            
            const num = player.number ? `(${player.number})` : '';
            const pos = player.position ? `${player.position} - ` : '';
            
            card.innerHTML = `
                <span class="font-medium text-sm text-gray-800">${pos}${player.name} ${num}</span>
            `;
            return card;
        }

        function renderBattingOrder() {
            DOMElements.battingOrderList.innerHTML = '';
            DOMElements.battingOrderListMale.innerHTML = '';
            DOMElements.battingOrderListFemale.innerHTML = '';

            const shouldHighlight = isUserTeamAtBat();
            
            // Helper to create indicators
            const createDot = (type) => {
                const dot = document.createElement('span');
                dot.className = "w-3 h-3 rounded-full ml-3 flex-shrink-0"; // Changed margin to ml-3 for right side
                if (type === 'current') dot.classList.add('bg-green-500');
                else if (type === 'next-opposite') dot.classList.add('bg-orange-500');
                else if (type === 'next-same') dot.classList.add('border-2', 'border-orange-500');
                return dot;
            };

            // Traditional List Logic
            let traditionalLength = gameState.battingOrder.traditional.length;
            gameState.battingOrder.traditional.forEach((player, index) => {
                const card = createBattingOrderCard(player);
                if (shouldHighlight && traditionalLength > 0) {
                    const rel = (index - (gameState.currentBatterIndex.traditional % traditionalLength) + traditionalLength) % traditionalLength;
                    if (rel === 0) card.appendChild(createDot('current'));
                    else if (rel === 1) card.appendChild(createDot('next-opposite'));
                    else if (rel === 2) card.appendChild(createDot('next-same'));
                }
                DOMElements.battingOrderList.appendChild(card);
            });

            // Wheel Lists Logic
            const nextBat = gameState.nextToBat; // 'male' or 'female'
            const mList = gameState.battingOrder.male;
            const mLen = mList.length;
            const mIdx = gameState.currentBatterIndex.male;

            const fList = gameState.battingOrder.female;
            const fLen = fList.length;
            const fIdx = gameState.currentBatterIndex.female;

            // Render Male List
            mList.forEach((player, index) => {
                const card = createBattingOrderCard(player);
                if (shouldHighlight && gameState.gameMode === 'wheel') {
                    if (nextBat === 'male') {
                        // Male is batting now (Green)
                        if (index === mIdx % (mLen || 1)) card.appendChild(createDot('current'));
                        // Next male is "In Hole" (Orange Ring)
                        else if (index === (mIdx + 1) % (mLen || 1)) card.appendChild(createDot('next-same'));
                    } else {
                        // Female is batting, Male is On Deck (Orange Dot)
                        if (index === mIdx % (mLen || 1)) card.appendChild(createDot('next-opposite'));
                    }
                }
                DOMElements.battingOrderListMale.appendChild(card);
            });

            // Render Female List
            fList.forEach((player, index) => {
                const card = createBattingOrderCard(player);
                if (shouldHighlight && gameState.gameMode === 'wheel') {
                    if (nextBat === 'female') {
                        // Female is batting now (Green)
                        if (index === fIdx % (fLen || 1)) card.appendChild(createDot('current'));
                        // Next female is "In Hole" (Orange Ring)
                        else if (index === (fIdx + 1) % (fLen || 1)) card.appendChild(createDot('next-same'));
                    } else {
                        // Male is batting, Female is On Deck (Orange Dot)
                        if (index === fIdx % (fLen || 1)) card.appendChild(createDot('next-opposite'));
                    }
                }
                DOMElements.battingOrderListFemale.appendChild(card);
            });

            validateBattingOrder();
        }

        function validateBattingOrder() {
            // No need to disable button, just show warning
            if (gameState.gameMode !== 'traditional' || gameState.battingOrder.traditional.length < 2) {
                DOMElements.battingOrderList.classList.remove('invalid-order');
                DOMElements.orderWarning.classList.add('hidden');
                return true;
            }

            let isValid = true;
            for (let i = 1; i < gameState.battingOrder.traditional.length; i++) {
                if (gameState.battingOrder.traditional[i].gender === gameState.battingOrder.traditional[i-1].gender) {
                    isValid = false;
                    break;
                }
            }

            DOMElements.battingOrderList.classList.toggle('invalid-order', !isValid);
            DOMElements.orderWarning.classList.toggle('hidden', isValid);
            
            return isValid;
        }

        function highlightCurrentBatter() {
            // Re-render batting order to update highlights
            renderBattingOrder();
        }

        // --- Event Handlers ---
        function handleInningToggle() {
            // This is now the main way to switch teams
            gameState.topOfInning = !gameState.topOfInning;
            // Clear everything for the new team
            gameState.outs = 0;
            gameState.runsThisInning = 0;
            gameState.runnerInningCounter = 0;
            clearBases();
            resetCounts(); // Resets to 1-1 count
            updateScoreboard();
            highlightCurrentBatter(); // Update highlight for new team

            const teamName = gameState.topOfInning ? 'Away' : 'Home';
            addLogEntry(`Manual override: Switched to ${teamName} team.`, 'info');
        }

        function handleGameModeSelect(e) {
            const mode = e.currentTarget.id === 'mode-traditional' ? 'traditional' : 'wheel';
            gameState.gameMode = mode;
            addLogEntry(`Game mode set to: ${mode}.`);
            
            DOMElements.gameModeModal.classList.add('hidden');
            
            if (mode === 'traditional') {
                DOMElements.traditionalContainer.classList.remove('hidden');
                DOMElements.traditionalContainer.classList.add('flex');
                DOMElements.wheelOrderContainer.classList.add('hidden'); // Corrected variable name
                DOMElements.wheelOrderContainer.classList.remove('md:grid'); // Corrected variable name
                // Next, ask for user's team
                DOMElements.userTeamModal.classList.remove('hidden');
            } else {
                DOMElements.traditionalContainer.classList.add('hidden');
                DOMElements.traditionalContainer.classList.remove('flex');
                DOMElements.wheelOrderContainer.classList.remove('hidden'); // Corrected variable name
                DOMElements.wheelOrderContainer.classList.add('md:grid'); // Corrected variable name
                
                // Show "Who Bats First?" modal
                DOMElements.whoBatsFirstModal.classList.remove('hidden');
            }
            renderBattingOrder();
        }

        function handleWhoBatsFirst(e) {
            // --- BUG FIX: Corrected assignment logic ---
            gameState.nextToBat = (e.currentTarget.id === 'start-male') ? 'male' : 'female';
            addLogEntry(`"Bat the Wheel" mode: ${gameState.nextToBat}s batting first.`);
            
            DOMElements.whoBatsFirstModal.classList.add('hidden');
            
            // Next, ask for user's team
            DOMElements.userTeamModal.classList.remove('hidden');
        }

        function handleUserTeamSelect(e) {
            gameState.userTeam = e.currentTarget.id === 'team-home' ? 'home' : 'away';
            addLogEntry(`User team set to: ${gameState.userTeam}.`);
            
            DOMElements.userTeamModal.classList.add('hidden');
            DOMElements.modalOverlay.classList.add('hidden'); // Close modal
            
            updateScoreboard(); // Show team highlight
            highlightCurrentBatter(); // Show initial highlight
            addLogEntry(`--- Game Start! Top of Inning 1. ---`, 'inning');
        }

        async function handleRosterSubmit(e) {
            e.preventDefault();
            const name = DOMElements.playerNameInput.value.trim();
            const number = DOMElements.playerNumberInput.value.trim();
            const position = DOMElements.playerPositionInput.value.trim();
            const gender = DOMElements.genderMaleInput.checked ? 'male' : 'female';
            
            if (!name || !userId) return;

            const newPlayer = { name, number, position, gender };

            try {
                // Roster is now stored at: artifacts/{appId}/users/{userId}/roster
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/roster`), newPlayer);
                addLogEntry(`Player added to roster: ${name}.`);
                // Clear inputs *except* gender
                DOMElements.playerNameInput.value = '';
                DOMElements.playerNumberInput.value = '';
                DOMElements.playerPositionInput.value = '';
                // The listener will auto-update the UI
            } catch (error) {
                console.error("Error adding player to Firestore: ", error);
            }
        }

        function handleAddPlayerToOrder(e) {
            e.stopPropagation(); // Prevent drag from starting
            const id = e.currentTarget.dataset.id;
            const player = gameState.roster.find(p => p.id === id);
            if (!player) return;

            let targetList;
            if (gameState.gameMode === 'traditional') {
                targetList = gameState.battingOrder.traditional;
            } else {
                targetList = (player.gender === 'male') ? gameState.battingOrder.male : gameState.battingOrder.female;
            }

            // Add player only if they are not already in the target list
            const exists = targetList.find(p => p.id === id);
            if (!exists) {
                targetList.push(player);
                addLogEntry(`Added ${player.name} to lineup.`);
                renderBattingOrder(); // Update the UI
                renderRoster(); // --- Re-render roster to hide plus button ---
            }
        }

        async function handleRemovePlayer(e) {
            e.stopPropagation(); // Prevent drag from starting
            const id = e.currentTarget.dataset.id;
            const player = gameState.roster.find(p => p.id === id);

            // Optimistically remove from local state
            gameState.roster = gameState.roster.filter(p => p.id !== id);
            gameState.battingOrder.traditional = gameState.battingOrder.traditional.filter(p => p.id !== id);
            gameState.battingOrder.male = gameState.battingOrder.male.filter(p => p.id !== id);
            gameState.battingOrder.female = gameState.battingOrder.female.filter(p => p.id !== id);
            
            renderRoster();
            renderBattingOrder();
            
            // Remove from Firestore
            try {
                // Doc path is now corrected to use appId
                const playerDocRef = doc(db, `artifacts/${appId}/users/${userId}/roster`, id);
                await deleteDoc(playerDocRef);
                if (player) addLogEntry(`Removed ${player.name} from roster.`);
            } catch (error) {
                console.error("Error removing player: ", error);
                // Note: If this fails, the local state will be out of sync
                // A more robust solution would reload from Firestore, but the listener should handle this
            }
        }
        
        function handleNextBatter(skipReset = false) {
            // --- NEW: Only advance batting order if it's the user's team ---
            if (isUserTeamAtBat() && validateBattingOrder()) {
                if (gameState.gameMode === 'traditional') {
                    if (gameState.battingOrder.traditional.length > 0) {
                        gameState.currentBatterIndex.traditional++;
                    }
                } else if (gameState.gameMode === 'wheel') {
                    if (gameState.nextToBat === 'male') {
                        if (gameState.battingOrder.male.length > 0) {
                            gameState.currentBatterIndex.male++;
                        }
                        gameState.nextToBat = 'female'; // Alternate
                    } else {
                        if (gameState.battingOrder.female.length > 0) {
                            gameState.currentBatterIndex.female++;
                        }
                        gameState.nextToBat = 'male'; // Alternate
                    }
                }
            }
            
            if (!skipReset) {
                 resetCounts(); // Resets to 1-1 (but not runsThisPlay)
            }
            highlightCurrentBatter();
        }

        // --- Drag and Drop Handlers ---

        function setupDragAndDrop() {
            const lists = [
                DOMElements.rosterList, 
                DOMElements.battingOrderList, 
                DOMElements.battingOrderListMale, 
                DOMElements.battingOrderListFemale
            ];
            
            lists.forEach(list => {
                list.addEventListener('dragstart', handleDragStart);
                list.addEventListener('dragover', handleDragOver);
                list.addEventListener('dragleave', handleDragLeave);
                list.addEventListener('drop', handleDrop);
                list.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            if (e.target.classList.contains('roster-card')) {
                draggedItem = e.target;
                dragSourceListId = e.currentTarget.id;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            } else {
                e.preventDefault();
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            const dropTarget = e.currentTarget;
            if (dropTarget.classList.contains('drag-over')) return;

            // --- Validation Logic ---
            const gender = draggedItem.dataset.gender;
            
            if (dropTarget.id === 'batting-order-list-male' && gender !== 'male') {
                return; // Can't drop female in male list
            }
            if (dropTarget.id === 'batting-order-list-female' && gender !== 'female') {
                return; // Can't drop male in female list
            }
            // All other drops (to roster, to traditional) are fine
            
            dropTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropTarget = e.currentTarget;
            dropTarget.classList.remove('drag-over');
            if (!draggedItem) return;
            
            // --- Validation on Drop ---
            const gender = draggedItem.dataset.gender;
            if (dropTarget.id === 'batting-order-list-male' && gender !== 'male') return;
            if (dropTarget.id === 'batting-order-list-female' && gender !== 'female') return;

            // Find drop position
            const afterElement = getDragAfterElement(dropTarget, e.clientY);
            const droppedPlayer = JSON.parse(draggedItem.dataset.playerData);
            
            // --- Update State ---
            const sourceList = getListById(dragSourceListId);
            const targetList = getListById(dropTarget.id);

            // Remove from source list (if not roster)
            if (dragSourceListId !== 'roster-list') {
                const index = sourceList.findIndex(p => p.id === droppedPlayer.id);
                if (index > -1) sourceList.splice(index, 1);
            }

            // Add to target list (if not roster)
            if (dropTarget.id !== 'roster-list') {
                // Ensure player isn't already in the target list (handles moving from roster)
                const exists = targetList.find(p => p.id === droppedPlayer.id);
                if (!exists) {
                    if (afterElement) {
                        const afterPlayer = JSON.parse(afterElement.dataset.playerData);
                        const index = targetList.findIndex(p => p.id === afterPlayer.id);
                        if(index > -1) targetList.splice(index, 0, droppedPlayer);
                        else targetList.push(droppedPlayer);
                    } else {
                        targetList.push(droppedPlayer);
                    }
                }
            }
            
            renderBattingOrder();
            addLogEntry(`Batting order updated.`);
            
            // --- NEW: Re-render roster if player was added/removed from it ---
            if (dragSourceListId === 'roster-list' || dropTarget.id === 'roster-list') {
                renderRoster();
            }
            // --- END NEW ---
        }

        function getListById(id) {
            switch(id) {
                case 'batting-order-list': return gameState.battingOrder.traditional;
                case 'batting-order-list-male': return gameState.battingOrder.male;
                case 'batting-order-list-female': return gameState.battingOrder.female;
                case 'roster-list': return gameState.roster;
                default: return null;
            }
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.roster-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function handleDragEnd() {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
                dragSourceListId = null;
            }
        }

function setupBaseActions() {
            // 1. Clicking the base itself opens the modal
            Object.keys(DOMElements.bases).forEach(baseNumStr => {
                const baseNum = parseInt(baseNumStr, 10);
                DOMElements.bases[baseNum].addEventListener('click', () => {
                    const runner = gameState.bases[baseNum];
                    if (runner) {
                        // Runner is present, show context menu
                        if(baseNum === 1) showModal(DOMElements.baseContextModal1);
                        else if(baseNum === 2) showModal(DOMElements.baseContextModal2);
                        else if(baseNum === 3) showModal(DOMElements.baseContextModal3);
                    }
                });
            });

            // 2. Clicking buttons inside the modals
            DOMElements.baseActionButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    // Find parent modal to know which base this is for
                    const modal = e.currentTarget.closest('div[id^="base-context-modal-"]');
                    const currentBaseNum = parseInt(modal.id.split('-').pop(), 10);
                    
                    if (action === 'cancel') {
                        hideAllModals();
                        return;
                    }

                    const runner = gameState.bases[currentBaseNum];
                    if (!runner) {
                        hideAllModals();
                        return;
                    }
                    
                    // Remove runner from current base
                    gameState.bases[currentBaseNum] = null;

                    if (action === 'move') {
                        const targetBaseNum = parseInt(e.currentTarget.dataset.base, 10);
                        
                        // Safety check: if target base is occupied, score the occupant to prevent data loss
                        if (gameState.bases[targetBaseNum]) {
                           addRuns(1, gameState.bases[targetBaseNum].name, true);
                        }
                        
                        gameState.bases[targetBaseNum] = runner;
                        addLogEntry(`${runner.name} manual move to ${targetBaseNum}.`, 'info');
                    } 
                    else if (action === 'score') {
                        addRuns(1, runner.name, true);
                    }
                    else if (action === 'out') {
                        // Record the out
                        addOut(`${runner.name} out on base.`);
                    }
                    
                    updateBases();
                    hideAllModals();
                });
            });
        }
        // --- Base click handlers ---
        function setupBaseClickListeners() {
            Object.keys(DOMElements.bases).forEach(baseNumStr => {
                const baseNum = parseInt(baseNumStr, 10);
                DOMElements.bases[baseNum].addEventListener('click', () => {
                    const runner = gameState.bases[baseNum];
                    if (runner) {
                        // Runner is present, show context menu
                        DOMElements.baseContextModal1.dataset.baseNum = baseNum;
                        DOMElements.baseContextModal2.dataset.baseNum = baseNum;
                        DOMElements.baseContextModal3.dataset.baseNum = baseNum;
                        
                        // Show the correct modal for the base
                        if(baseNum === 1) showModal(DOMElements.baseContextModal1);
                        else if(baseNum === 2) showModal(DOMElements.baseContextModal2);
                        else if(baseNum === 3) showModal(DOMElements.baseContextModal3);
                    }
                    // If base is empty, do nothing
                });
            });
        }
        
        // --- RUNNER NUMBERING FIX ---
        function renumberRunnersOnBase(outRunnerDisplayOrder) {
            // Get all runners on base
            const runnersOnBase = [];
            for (let i = 1; i <= 3; i++) {
                if (gameState.bases[i]) {
                    runnersOnBase.push(gameState.bases[i]);
                }
            }
            
            // --- NEW LOGIC: Also decrement the inning counter ---
            // This means the next batter will get the "recycled" number
            gameState.runnerInningCounter--;
            // --- END NEW LOGIC ---

            // Find all runners with a displayOrder > outRunnerDisplayOrder
            runnersOnBase.forEach(runner => {
                if (runner.displayOrder > outRunnerDisplayOrder) {
                    runner.displayOrder -= 1; // Reduce their number by one
                }
            });
            
            updateBases(); // Update UI with new numbers
        }
        // --- END RUNNER NUMBERING FIX ---

        // --- RESTORED initAuth FUNCTION ---
        async function initAuth() {
            try {
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, user => {
                    if (user) {
                        console.log("User is authenticated:", user.uid);
                        userId = user.uid;
                        DOMElements.userIdDisplay.textContent = userId;
                        // User is signed in, set up Firestore references and listener
                        
                        // Use the path compatible with the provided security rules
                        rosterCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/roster`);
                        
                        // Call setupRosterListener wrapped in a short delay to ensure permissions are fully propagated
                        setTimeout(setupRosterListener, 100); 
                    } else {
                        console.log("User is not authenticated.");
                        userId = null;
                        DOMElements.userIdDisplay.textContent = 'not signed in';
                        unsubscribeRoster(); // Stop listening if logged out
                        gameState.roster = [];
                        renderRoster();
                    }
                });

                // Sign in Anonymously
                console.log("Signing in anonymously...");
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                DOMElements.userIdDisplay.textContent = 'Error';
            }
        }
        
        function setupRosterListener() {
            if (!rosterCollectionRef) return;

            // Stop any previous listener
            unsubscribeRoster();
            
            console.log("Setting up roster listener at:", rosterCollectionRef.path);
            
            unsubscribeRoster = onSnapshot(rosterCollectionRef, (snapshot) => {
                console.log("Roster data received from Firestore.");
                const newRoster = [];
                snapshot.forEach((doc) => {
                    newRoster.push({ id: doc.id, ...doc.data() });
                });
                gameState.roster = newRoster;
                renderRoster();
                // When roster reloads, re-render batting order to check for + buttons
                renderBattingOrder();
            }, (error) => {
                console.error("Error with roster snapshot: ", error);
            });
        }

        // --- Roster Toggle ---
        function handleRosterToggle() {
            gameState.rosterMinimized = !gameState.rosterMinimized;
            DOMElements.rosterToggleContent.style.maxHeight = gameState.rosterMinimized ? '0px' : '1000px';
            DOMElements.rosterToggleContent.style.opacity = gameState.rosterMinimized ? '0' : '1';
            DOMElements.rosterToggleBtn.textContent = gameState.rosterMinimized ? '+' : '-';
        }
        DOMElements.rosterToggleBtn.onclick = handleRosterToggle;

        // --- FIX: Unified handleGameLogToggle usage ---
        DOMElements.gameLogToggleBtn.onclick = handleGameLogToggle;
        
        // --- BUTTON HANDLERS ---
        DOMElements.modeTraditionalBtn.addEventListener('click', handleGameModeSelect);
        DOMElements.modeWheelBtn.addEventListener('click', handleGameModeSelect);
        DOMElements.startMaleBtn.addEventListener('click', handleWhoBatsFirst);
        DOMElements.startFemaleBtn.addEventListener('click', handleWhoBatsFirst);
        DOMElements.teamHomeBtn.addEventListener('click', handleUserTeamSelect);
        DOMElements.teamAwayBtn.addEventListener('click', handleUserTeamSelect);

        // --- MISSING EVENT LISTENERS RESTORED ---
        DOMElements.addPlayerForm.addEventListener('submit', handleRosterSubmit);
        
        DOMElements.btnWalk.addEventListener('click', () => {
            // Reset "Runs This Play" only for new actions
            gameState.runsThisPlay = 0;
            
            const batter = getCurrentBatter();
            advanceRunnersOnWalk(batter);
            handleNextBatter();
        });

        DOMElements.btnHit.addEventListener('click', () => {
            // Reset "Runs This Play" only for new actions
            gameState.runsThisPlay = 0;
            showModal(DOMElements.hitTypeModal);
        });

        DOMElements.btnOut.addEventListener('click', () => {
            // Reset "Runs This Play" only for new actions
            gameState.runsThisPlay = 0;
            
            const batter = getCurrentBatter();
            const batterName = getBatterName(batter);
            const isThirdOut = addOut(`${batterName} is out.`, false); 
            if (!isThirdOut) {
                handleNextBatter();
            }
        });

        DOMElements.btnAddBall.addEventListener('click', () => {
            // Reset "Runs This Play" only for new actions
            gameState.runsThisPlay = 0;
            
            if (gameState.balls < 3) {
                gameState.balls++;
                updateScoreboard();
            } else {
                const batter = getCurrentBatter();
                advanceRunnersOnWalk(batter);
                handleNextBatter();
            }
        });

        DOMElements.btnAddStrike.addEventListener('click', () => {
             // Reset "Runs This Play" only for new actions
             gameState.runsThisPlay = 0;
             
             if (gameState.strikes < 2) {
                gameState.strikes++;
                updateScoreboard();
            } else {
                const batter = getCurrentBatter();
                const batterName = getBatterName(batter);
                const isThirdOut = addOut(`${batterName} strikes out.`, false);
                 if (!isThirdOut) {
                    handleNextBatter();
                }
            }
        });
        
        // --- Event Listeners for HIT Buttons (Single, Double, etc.) ---
        DOMElements.hitTypeButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const hitType = parseInt(e.currentTarget.dataset.hitType, 10);
                const batter = getCurrentBatter();
                advanceRunnersOnHit(batter, hitType); 
            });
        });

        // --- Event Listener for Cancel Hit Button ---
        DOMElements.cancelHitButton.addEventListener('click', () => {
            hideAllModals();
        });
        
        // --- Event Listeners for Force Out Modal ---
        DOMElements.forceOutYesBtn.addEventListener('click', () => handleForceOut(true));
        DOMElements.forceOutNoBtn.addEventListener('click', () => handleForceOut(false));

        DOMElements.btnEndGame.addEventListener('click', () => {
             // Show the custom modal instead of confirm()
             showModal(DOMElements.endGameModal);
        });
        
        // --- Event Listeners for Custom End Game Modal ---
        document.getElementById('end-game-yes').addEventListener('click', () => {
             // Reset Game State vars
             gameState.homeScore = 0;
             gameState.awayScore = 0;
             gameState.inning = 1;
             gameState.topOfInning = true;
             gameState.balls = STARTING_BALLS;
             gameState.strikes = STARTING_STRIKES;
             gameState.outs = 0;
             gameState.runsThisInning = 0;
             gameState.runsThisPlay = 0;
             gameState.runnerInningCounter = 0;
             gameState.bases = { 1: null, 2: null, 3: null };
             
             // Reset Batter Indexes
             gameState.currentBatterIndex = { traditional: 0, male: 0, female: 0 };
             
             // Clear Log
             gameState.gameLog = [];
             DOMElements.gameLogList.innerHTML = '';
             
             // Update UI
             updateScoreboard();
             updateBases();
             renderBattingOrder();
             
             hideAllModals();
             // Re-prompt for side
             showModal(DOMElements.userTeamModal);
             addLogEntry("New Game Started.");
        });

        document.getElementById('end-game-no').addEventListener('click', () => {
            hideAllModals();
        });

        function init() {
            updateScoreboard();
            updateBases();
            showModal(DOMElements.gameModeModal);
            initAuth();
            setupBaseActions();
            handleRosterToggle();
            handleGameLogToggle();
            setupDragAndDrop(); // Added setupDragAndDrop to init
            setupGameLogResize(); // Added game log resize to init
        }

        document.addEventListener('DOMContentLoaded', init);
        console.log("Version 5 loaded.");
    </script>
</body>
</html>
